name: Test WSL2 on Windows 2025

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  Build_Custom_RockyWSL:
    runs-on: windows-2025
    env:
      WSL_FILE: Rocky-10-WSL-Base-10.1-20251116.0.x86_64.wsl

    steps:
      - uses: actions/checkout@v4
      - name: Download Rocky Linux WSL
        shell: bash
        run: |
          curl -L -o ${WSL_FILE} https://dl.rockylinux.org/pub/rocky/10.1/images/x86_64/${WSL_FILE}

      - name: Customize WSL rootfs
        shell: bash
        run: |
          BUILDER_FILE="${WSL_FILE%.wsl}-Builder.wsl"
          cp "${WSL_FILE}" "${BUILDER_FILE}"
          gunzip -c "${BUILDER_FILE}" > builder.tar
          tar -x -f builder.tar usr/libexec/wsl/oobe.sh
          sed -i 's/^read.*/username=zion/' usr/libexec/wsl/oobe.sh
          tar --delete -f builder.tar usr/libexec/wsl/oobe.sh
          tar -rf builder.tar usr/libexec/wsl/oobe.sh
          gzip -f builder.tar
          mv builder.tar.gz "${BUILDER_FILE}"
          rm -rf usr

      - name: Import to WSL2 from wsl file
        shell: bash
        run: |
          BUILDER_FILE="${WSL_FILE%.wsl}-Builder.wsl"
          mkdir RockyBuilder
          wsl --import RockyBuilder ./RockyBuilder ./${BUILDER_FILE} --version 2
          rm -rf ${BUILDER_FILE}
          ls -alh

      - name: RockyBuilder Prapare Environment
        shell: bash
        run: |
          BUILDER_FILE="${WSL_FILE%.wsl}-Builder.wsl"
          wsl -d RockyBuilder -- bash -s <<'WSL_EOF'
            rpm_path="RPM_PATH"
            mkdir -p ${rpm_path}

            echo "üîç Ê£ÄÊµã RockyLinux ‰∏ªÁâàÊú¨Âè∑..."
            MAJOR_VERSION=$(rpm -q --qf '%{VERSION}' rocky-release | cut -d '.' -f 1)
            echo "üìå RockyLinux ‰∏ªÁâàÊú¨Âè∑: ${MAJOR_VERSION}"

            echo "üì¶ ÂÆâË£Ö EPEL ‰ªìÂ∫ì..."
            sudo rpm -ivh https://dl.fedoraproject.org/pub/epel/epel-release-latest-"${MAJOR_VERSION}".noarch.rpm

            echo "üîÑ Âà∑Êñ∞ DNF ÁºìÂ≠ò..."
            sudo dnf makecache

            echo "üìÇ ÂàáÊç¢Âà∞ RPM Â≠òÊîæÁõÆÂΩï: ${rpm_path}"
            cd "${rpm_path}"
            mkdir -p 01-update 02-base 03-epel 06-docker

            echo "‚¨áÔ∏è [1/6] ‰∏ãËΩΩÂπ∂Êõ¥Êñ∞Á≥ªÁªü RPM Âà∞ 01-update..."
            sudo dnf update -y --downloadonly --downloaddir=01-update
            echo "‚úÖ Á≥ªÁªüÊõ¥Êñ∞ RPM ‰∏ãËΩΩÂÆåÊàê"

            echo "üì¶ [2/6] ÂÆâË£Ö 01-update ‰∏≠ÁöÑ RPM..."
            sudo dnf install -y --setopt=keepcache=1 01-update/*.rpm
            echo "‚úÖ Á≥ªÁªüÊõ¥Êñ∞ÂÆåÊàê"

            echo "‚¨áÔ∏è [3/6] ‰∏ãËΩΩÂü∫Á°ÄÂ∑•ÂÖ∑ RPM Âà∞ 02-base..."
            sudo dnf download -y --resolve --downloaddir=02-base ncurses net-tools wget xz vim nano telnet python3-pip sysstat iotop bc dos2unix
            echo "‚úÖ Âü∫Á°ÄÂ∑•ÂÖ∑‰∏ãËΩΩÂÆåÊàê"

            echo "‚¨áÔ∏è [4/6] ‰∏ãËΩΩ EPEL ËΩØ‰ª∂ÂåÖÂà∞ 03-epel..."
            sudo dnf download -y --resolve --downloaddir=03-epel epel-release ncdu htop fastfetch p7zip
            echo "‚úÖ EPEL ËΩØ‰ª∂ÂåÖ‰∏ãËΩΩÂÆåÊàê"

            echo "üõ† Ê∑ªÂä† Docker ÂÆòÊñπ‰ªìÂ∫ì..."
            sudo dnf config-manager --add-repo https://download.docker.com/linux/rhel/docker-ce.repo

            echo "üìÇ Â§çÂà∂ docker-ce.repo Âà∞ 06-docker..."
            sudo cp -p /etc/yum.repos.d/docker-ce.repo 06-docker/

            echo "‚¨áÔ∏è [6/6] ‰∏ãËΩΩ Docker Áõ∏ÂÖ≥ RPM Âà∞ 06-docker..."
            sudo dnf download -y --resolve --downloaddir=06-docker docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            echo "‚úÖ Docker Áõ∏ÂÖ≥‰∏ãËΩΩÂÆåÊàê"

            ls -alh
          WSL_EOF

      - name: Build Customize WSL Image
        shell: bash
        run: |
          wsl -d RockyBuilder -- bash -s <<'WSL_EOF'
            echo "üñ•Ô∏è Ê£ÄÊµãÁ≥ªÁªüÊû∂ÊûÑÂíåÁâàÊú¨..."
            arch=$(uname -m)
            MAJOR_VERSION=$(rpm -q --qf '%{VERSION}' rocky-release | cut -d '.' -f 1)

            temp_path="temp_${RANDOM}"
            wsl_name="Rocky-10-WSL-Base-10.1-20251116.0.x86_64.wsl"

            echo "üì¶ ÂÆâË£Ö‰æùËµñÂ∑•ÂÖ∑..."
            dnf install -y xz

            echo "üîß Â§ÑÁêÜWSLÈïúÂÉèÊñá‰ª∂..."
            echo "  ‚Üí Ëß£Âéã $wsl_name..."
            gzip -d -S .wsl -N "$wsl_name"
            tar_name=$(ls -- *.wsl 2>/dev/null | head -1)

            echo "üìÇ Ëß£ÂåÖWSLÈïúÂÉè..."
            mkdir -p ${temp_path}
            tar -xf "${tar_name}" -C ${temp_path}
            rm -rf "${tar_name}"
            mv ${temp_path} "${tar_name}"

            cd "${tar_name}"
            echo "‚öôÔ∏è ‰øÆÊîπÂèëË°åÁâàÈÖçÁΩÆ..."
            sed -i "s/^defaultName.*/defaultName = RockyLinux-$MAJOR_VERSION/" etc/wsl-distribution.conf
            cp -P "Rocky/logo.ico" usr/share/pixmaps/fedora-logo.ico
            cp -P "Rocky/bash-color-prompt.sh" etc/profile.d/bash-color-prompt.sh

            echo "üõ†Ô∏è ÂáÜÂ§áOOBEÈÖçÁΩÆ..."
            mkdir -p "tmp/oobe"
            cp -P "Rocky/10.1/oobe.sh" usr/libexec/wsl/oobe.sh
            cp -rP "RPM_PATH/{01-update,02-base,03-epel,06-docker}" "tmp/oobe/"

            echo "üì¶ ÈáçÊñ∞ÊâìÂåÖÈïúÂÉè..."
            tar --numeric-owner --format=posix -cf "/${tar_name}" -- *
            CURRENT_DATE=$(date +"%Y%m%d")
            NEW_FILENAME="${wsl_name%.wsl}-Docker-${CURRENT_DATE}"
            echo "üóúÔ∏è ÁîüÊàêÂéãÁº©ÈïúÂÉè..."
            echo "  ‚Üí XZÊ†ºÂºèÂéãÁº©‰∏≠..."
            xz -9ckvT8 "/${tar_name}" > "${wsl_dir}/${NEW_FILENAME}.xz.wsl"
            echo -e "\n‚úÖ Â§ÑÁêÜÂÆåÊàê!"
          WSL_EOF

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            *.xz.wsl
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

      - name: Cleanup
        shell: bash
        run: |
          echo "Cleaning up..."
          wsl --unregister RockyBuilder
          ls -alh
