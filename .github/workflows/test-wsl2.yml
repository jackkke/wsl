name: Test WSL2 on Windows 2025

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  test-wsl2-import:
    runs-on: windows-2025
    env:
      WSL_FILE: Rocky-10-WSL-Base-10.1-20251116.0.x86_64.wsl

    steps:
      - name: Download Rocky Linux WSL
        shell: bash
        run: |
          curl -L -o ${WSL_FILE} https://dl.rockylinux.org/pub/rocky/10.1/images/x86_64/${WSL_FILE}

      - name: Customize WSL rootfs
        shell: bash
        run: |
          BUILDER_FILE="${WSL_FILE%.wsl}-Builder.wsl"
          cp "${WSL_FILE}" "${BUILDER_FILE}"
          gunzip -c "${BUILDER_FILE}" > builder.tar
          tar -x -f builder.tar usr/libexec/wsl/oobe.sh
          sed -i 's/^read.*/username=zion/' usr/libexec/wsl/oobe.sh
          tar --delete -f builder.tar usr/libexec/wsl/oobe.sh
          tar -rf builder.tar usr/libexec/wsl/oobe.sh
          gzip -f builder.tar
          mv builder.tar.gz "${BUILDER_FILE}"
          rm -rf usr

      - name: Import to WSL2 from wsl file
        shell: bash
        run: |
          BUILDER_FILE="${WSL_FILE%.wsl}-Builder.wsl"
          mkdir RockyBuilder
          wsl --import RockyBuilder ./RockyBuilder ./${BUILDER_FILE} --version 2
          rm -rf ${BUILDER_FILE}
          ls -alh

      - name: RockyBuilder Prapare Environment
        shell: bash
        run: |
          BUILDER_FILE="${WSL_FILE%.wsl}-Builder.wsl"
          wsl -d RockyBuilder -- bash -c '
            rpm_path="RPM_PATH"
            mkdir -p ${rpm_path}

            echo "ğŸ” æ£€æµ‹ RockyLinux ä¸»ç‰ˆæœ¬å·..."
            MAJOR_VERSION=$(rpm -q --qf '%{VERSION}' rocky-release | cut -d '.' -f 1)
            echo "ğŸ“Œ RockyLinux ä¸»ç‰ˆæœ¬å·: ${MAJOR_VERSION}"

            echo "ğŸ“¦ å®‰è£… EPEL ä»“åº“..."
            sudo rpm -ivh https://dl.fedoraproject.org/pub/epel/epel-release-latest-"${MAJOR_VERSION}".noarch.rpm >/dev/null

            echo "ğŸ”„ åˆ·æ–° DNF ç¼“å­˜..."
            sudo dnf makecache >/dev/null

            echo "ğŸ“‚ åˆ‡æ¢åˆ° RPM å­˜æ”¾ç›®å½•: ${rpm_path}"
            cd "${rpm_path}"
            mkdir -p 01-update 02-base 03-epel 06-docker

            echo "â¬‡ï¸ [1/6] ä¸‹è½½å¹¶æ›´æ–°ç³»ç»Ÿ RPM åˆ° 01-update..."
            sudo dnf update -y --downloadonly --downloaddir=01-update >/dev/null
            echo "âœ… ç³»ç»Ÿæ›´æ–° RPM ä¸‹è½½å®Œæˆ"

            echo "ğŸ“¦ [2/6] å®‰è£… 01-update ä¸­çš„ RPM..."
            sudo dnf install -y --setopt=keepcache=1 01-update/*.rpm >/dev/null
            echo "âœ… ç³»ç»Ÿæ›´æ–°å®Œæˆ"

            echo "â¬‡ï¸ [3/6] ä¸‹è½½åŸºç¡€å·¥å…· RPM åˆ° 02-base..."
            sudo dnf download -y --resolve --downloaddir=02-base ncurses net-tools wget xz vim nano telnet python3-pip sysstat iotop bc dos2unix >/dev/null
            echo "âœ… åŸºç¡€å·¥å…·ä¸‹è½½å®Œæˆ"

            echo "â¬‡ï¸ [4/6] ä¸‹è½½ EPEL è½¯ä»¶åŒ…åˆ° 03-epel..."
            sudo dnf download -y --resolve --downloaddir=03-epel epel-release ncdu htop fastfetch p7zip >/dev/null
            echo "âœ… EPEL è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"

            echo "ğŸ›  æ·»åŠ  Docker å®˜æ–¹ä»“åº“..."
            sudo dnf config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo >/dev/null

            echo "ğŸ“‚ å¤åˆ¶ docker-ce.repo åˆ° 06-docker..."
            sudo cp -p /etc/yum.repos.d/docker-ce.repo 06-docker/

            echo "â¬‡ï¸ [6/6] ä¸‹è½½ Docker ç›¸å…³ RPM åˆ° 06-docker..."
            sudo dnf download -y --resolve --downloaddir=06-docker docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin >/dev/null
            echo "âœ… Docker ç›¸å…³ä¸‹è½½å®Œæˆ"

            ls -alh
          '

      - name: Cleanup
        run: |
          echo "Cleaning up..."
          wsl --unregister rocky
