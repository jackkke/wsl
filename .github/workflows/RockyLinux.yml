name: Custom WSL

on:
  workflow_dispatch:
  push:
    tags: [ 'RockyLinux-*' ]

permissions:
  contents: write

jobs:
  Build_Custom_RockyWSL:
    runs-on: windows-2025
    env:
      WSL_FILE: Rocky-10-WSL-Base-10.1-20251116.0.x86_64.wsl

    steps:
      - uses: actions/checkout@v6
      - name: Download Rocky Linux WSL
        shell: bash
        run: |
          curl -L -o ${WSL_FILE} https://dl.rockylinux.org/pub/rocky/10.1/images/x86_64/${WSL_FILE}

      - name: Import to WSL2 from wsl file
        shell: bash
        run: |
          mkdir RockyBuilder
          wsl --install --from-file ./${WSL_FILE} --location ./RockyBuilder --name RockyBuilder --no-launch --version 2

      - name: RockyBuilder Prapare Environment
        shell: bash
        run: |
          wsl -d RockyBuilder -- bash -s <<'WSL_EOF'
            cd /root
            rpm_path="RPM_PATH"
            mkdir -p ${rpm_path}

            echo "üîç Ê£ÄÊµã RockyLinux ‰∏ªÁâàÊú¨Âè∑..."
            MAJOR_VERSION=$(rpm -q --qf '%{VERSION}' rocky-release | cut -d '.' -f 1)
            echo "üìå RockyLinux ‰∏ªÁâàÊú¨Âè∑: ${MAJOR_VERSION}"

            echo "üì¶ ÂÆâË£Ö EPEL ‰ªìÂ∫ì..."
            rpm -ivh https://dl.fedoraproject.org/pub/epel/epel-release-latest-"${MAJOR_VERSION}".noarch.rpm

            echo "üîÑ Âà∑Êñ∞ DNF ÁºìÂ≠ò..."
            dnf makecache

            echo "üìÇ ÂàáÊç¢Âà∞ RPM Â≠òÊîæÁõÆÂΩï: ${rpm_path}"
            cd "${rpm_path}"
            mkdir -p 01-update 02-base 03-epel 06-docker

            echo "‚¨áÔ∏è [1/6] ‰∏ãËΩΩÂπ∂Êõ¥Êñ∞Á≥ªÁªü RPM Âà∞ 01-update..."
            dnf update -y --downloadonly --downloaddir=01-update
            echo "‚úÖ Á≥ªÁªüÊõ¥Êñ∞ RPM ‰∏ãËΩΩÂÆåÊàê"

            echo "üì¶ [2/6] ÂÆâË£Ö 01-update ‰∏≠ÁöÑ RPM..."
            dnf install -y --setopt=keepcache=1 01-update/*.rpm
            echo "‚úÖ Á≥ªÁªüÊõ¥Êñ∞ÂÆåÊàê"

            echo "‚¨áÔ∏è [3/6] ‰∏ãËΩΩÂü∫Á°ÄÂ∑•ÂÖ∑ RPM Âà∞ 02-base..."
            dnf download -y --resolve --downloaddir=02-base ncurses net-tools wget xz vim nano telnet python3-pip sysstat iotop bc dos2unix
            echo "‚úÖ Âü∫Á°ÄÂ∑•ÂÖ∑‰∏ãËΩΩÂÆåÊàê"

            echo "‚¨áÔ∏è [4/6] ‰∏ãËΩΩ EPEL ËΩØ‰ª∂ÂåÖÂà∞ 03-epel..."
            dnf download -y --resolve --downloaddir=03-epel epel-release ncdu htop fastfetch p7zip
            echo "‚úÖ EPEL ËΩØ‰ª∂ÂåÖ‰∏ãËΩΩÂÆåÊàê"

            echo "üõ† Ê∑ªÂä† Docker ÂÆòÊñπ‰ªìÂ∫ì..."
            dnf config-manager --add-repo https://download.docker.com/linux/rhel/docker-ce.repo

            echo "üìÇ Â§çÂà∂ docker-ce.repo Âà∞ 06-docker..."
            cp -p /etc/yum.repos.d/docker-ce.repo 06-docker/

            echo "‚¨áÔ∏è [6/6] ‰∏ãËΩΩ Docker Áõ∏ÂÖ≥ RPM Âà∞ 06-docker..."
            dnf download -y --resolve --downloaddir=06-docker docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            echo "‚úÖ Docker Áõ∏ÂÖ≥‰∏ãËΩΩÂÆåÊàê"
          WSL_EOF

      - name: Build Customize WSL Image
        shell: bash
        run: |
          wsl -d RockyBuilder -- bash -s <<'WSL_EOF'
            ORIGINAL_WIN_DIR="$(pwd)"
            echo "ÂéüÂßã Windows ÁõÆÂΩïÔºàWSL ËßÜËßíÔºâ: $ORIGINAL_WIN_DIR"
            echo "üñ•Ô∏è Ê£ÄÊµãÁ≥ªÁªüÊû∂ÊûÑÂíåÁâàÊú¨..."
            MAJOR_VERSION=$(rpm -q --qf '%{VERSION}' rocky-release | cut -d '.' -f 1)

            echo "üì¶ ÂÆâË£Ö‰æùËµñÂ∑•ÂÖ∑..."
            dnf install -y xz

            wsl_name="$(ls *.wsl | head -1)"
            mv "${ORIGINAL_WIN_DIR}/${wsl_name}" /root
            mv "${ORIGINAL_WIN_DIR}/Rocky" /root
            cd /root
            echo "  ‚Üí Ëß£Âéã $wsl_name ‰∏∫ tar..."
            gzip -d -S .wsl -N "$wsl_name"
            rm -rf $wsl_name

            tar_name="$(ls *.wsl | head -1)"
            echo "üìÇ Ëß£ÂåÖ tar ${tar_name}..."
            temp_path="temp_${RANDOM}"
            mkdir -p "${temp_path}"
            tar -pxf "${tar_name}" -C "${temp_path}"
            rm -rf "${tar_name}"
            mv "${temp_path}" "${tar_name}"

            cd "${tar_name}"
            echo "‚öôÔ∏è ‰øÆÊîπÂèëË°åÁâàÈÖçÁΩÆ..."
            sed -i "s/^defaultName.*/defaultName = RockyLinux-${MAJOR_VERSION}/" etc/wsl-distribution.conf
            cp -P "../Rocky/logo.ico" usr/share/pixmaps/fedora-logo.ico
            cp -P "../Rocky/bash-color-prompt.sh" etc/profile.d/bash-color-prompt.sh

            echo "üõ†Ô∏è ÂáÜÂ§áOOBEÈÖçÁΩÆ..."
            mkdir -p tmp/oobe
            cp -P "../Rocky/10.1/oobe.sh" usr/libexec/wsl/oobe.sh
            cp -rP ../RPM_PATH/{01-update,02-base,03-epel,06-docker} tmp/oobe/

            ls -alh
            echo "üì¶ ÈáçÊñ∞ÊâìÂåÖÈïúÂÉè..."
            tar --numeric-owner --format=posix -cpf "/${tar_name}" -- *
            CURRENT_DATE="$(date +%Y%m%d)"
            NEW_FILENAME="${wsl_name%.wsl}-Docker-${CURRENT_DATE}"
            echo "  ‚Üí XZÊ†ºÂºèÂéãÁº©‰∏≠..."
            xz -9ckvT8 "/${tar_name}" > "../${NEW_FILENAME}.xz.wsl"
            echo -e "\n‚úÖ Â§ÑÁêÜÂÆåÊàê!"
            mv *.xz.wsl "${ORIGINAL_WIN_DIR}/"
          WSL_EOF

      - name: Cleanup
        shell: bash
        run: |
          wsl --unregister RockyBuilder

      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          files: |
            *.xz.wsl
