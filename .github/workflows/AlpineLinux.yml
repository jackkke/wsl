name: Custom WSL2 AlpineLinux

on:
  push:
    tags: [ 'Alpine-*.*.*-*' ]

permissions:
  contents: write

jobs:
  Build_Custom_RockyWSL:
    runs-on: windows-2025

    steps:
      - uses: actions/checkout@v6
      - name: inspect tag info
        id: parse_tag
        run: |
          $tag = "${{ github.ref_name }}"
          $parts = $tag.Split('-')
          $base_version   = $parts[1]
          $custom_version = $parts[2]
          $major_minor    = 'v' + ($base_version.Split('.')[0..1] -join '.')
          $filename       = "alpine-minirootfs-$base_version-x86_64.tar.gz"
          "BASE_VERSION=$base_version" >> $env:GITHUB_ENV
          "CUSTOM_VERSION=$custom_version" >> $env:GITHUB_ENV
          "MAJOR_MINOR=$major_minor" >> $env:GITHUB_ENV
          "WSL_FILE=$filename" >> $env:GITHUB_ENV
      - name: Download Alpine Linux WSL
        shell: bash
        run: |
          curl -LO "https://dl-cdn.alpinelinux.org/alpine/$MAJOR_MINOR/releases/x86_64/$WSL_FILE"

      - name: Import to WSL2 from tar.gz file
        shell: bash
        run: |
          mkdir AlpineBuilder
          wsl --import AlpineBuilder ./AlpineBuilder ./${WSL_FILE} --version 2

      - name: AlpineBuilder Prapare Environment
        shell: bash
        run: |
          wsl -d AlpineBuilder -- sh -s <<'WSL_EOF'
            cd /root
            rpm_path="RPM_PATH"
            mkdir -p ${rpm_path}
            echo "üîÑ Âà∑Êñ∞ APK ÁºìÂ≠òÂπ∂Êõ¥Êñ∞Á≥ªÁªü..."

            echo "üìÇ ÂàáÊç¢Âà∞ RPM Â≠òÊîæÁõÆÂΩï: ${rpm_path}"
            cd "${rpm_path}"
            mkdir -p 01-update 02-base

            echo "‚¨áÔ∏è ‰∏ãËΩΩÁ≥ªÁªüÊõ¥Êñ∞ÂåÖÂà∞ 01-update..."
            apk update && apk list -u -q | xargs apk fetch -R -o 01-update
            echo "‚úÖ Á≥ªÁªüÊõ¥Êñ∞ÂåÖÂáÜÂ§áÂÆåÊàê"

            echo "üì¶ [2/4] ÂÆâË£ÖÁ≥ªÁªüÊõ¥Êñ∞..."
            apk upgrade
            echo "‚úÖ Á≥ªÁªüÊõ¥Êñ∞ÂÆåÊàê"

            echo "‚¨áÔ∏è ‰∏ãËΩΩÊûÅÁÆÄÂåÖÂà∞ 02-base ÁõÆÂΩï..."
            apk fetch -R -o 02-base/ alpine-base apk-tools apk-tools-bash-completion bash bash-completion ca-certificates coreutils curl iproute2 less libapk nano networkmanager networkmanager-openrc procps sudo tzdata
            echo "‚úÖ ‰∏ãËΩΩÂÆåÊàêÔºÅ"
          WSL_EOF

      - name: Build Customize Alpine WSL Image
        shell: bash
        run: |
          wsl -d AlpineBuilder -- sh -s "$WSL_FILE" "$CUSTOM_VERSION" <<'WSL_EOF'
            ORIGINAL_WIN_DIR="$(pwd)"
            echo "ÂéüÂßã Windows ÁõÆÂΩïÔºàWSL ËßÜËßíÔºâ: $ORIGINAL_WIN_DIR"
            echo "üì¶ ÂÆâË£Ö‰æùËµñÂ∑•ÂÖ∑..."
            apk add xz gzip tar

            gz_name="$1"
            mv "${ORIGINAL_WIN_DIR}/${gz_name}" /root
            mv "${ORIGINAL_WIN_DIR}/Alpine" /root

            cd /root
            echo "  ‚Üí Ëß£Âéã $gz_name ‰∏∫ tar..."
            gzip -d -S .tar -N "$gz_name"
            rm -rf $gz_name

            tar_name="$(ls *.tar | head -1)"
            echo "üìÇ Ëß£ÂåÖ tar ${tar_name}..."
            temp_path="temp_${RANDOM}"
            mkdir -p "${temp_path}"
            tar -pxf "${tar_name}" -C "${temp_path}"
            rm -rf "${tar_name}"
            mv "${temp_path}" "${tar_name}"

            cd "${tar_name}"
            echo "‚öôÔ∏è ‰øÆÊîπÂèëË°åÁâàÈÖçÁΩÆ..."
            mkdir -p etc/oobe
            mkdir -p etc/sudoers.d
            mkdir -p usr/lib/wsl
            cp -aP ../Alpine/etc/. etc/
            rm -rf etc/oobe-docker.sh
            cp -aP ../Alpine/usr/. usr/
            cp -rP ../RPM_PATH/* etc/oobe/

            echo "üì¶ ÈáçÊñ∞ÊâìÂåÖÈïúÂÉè..."
            tar --numeric-owner --format=posix -cpf "/${tar_name}" -- *
            NEW_FILENAME="${gz_name%.tar.gz}-$2"
            echo "  ‚Üí XZÊ†ºÂºèÂéãÁº©‰∏≠..."
            xz -9ckvT8 "/${tar_name}" > "../${NEW_FILENAME}.xz.wsl"
            echo -e "\n‚úÖ Â§ÑÁêÜÂÆåÊàê!"
            ls -alh
            cd ../
            ls -alh
            mv *.xz.wsl "${ORIGINAL_WIN_DIR}/"
          WSL_EOF

      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          files: |
            *.xz.wsl
