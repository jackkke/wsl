name: Custom Alpine Test WSL

on:
  workflow_dispatch:
  push:
    tags: [ 'AlpineTest-*' ]

permissions:
  contents: write

jobs:
  Build_Custom_RockyWSL:
    runs-on: windows-2025
    env:
      WSL_FILE: alpine-minirootfs-3.23.2-x86_64.tar.gz

    steps:
      - uses: actions/checkout@v6
      - name: Download Alpine Linux WSL
        shell: bash
        run: |
          curl -L -o ${WSL_FILE} https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86_64/${WSL_FILE}

      - name: Import to WSL2 from tar.gz file
        shell: bash
        run: |
          mkdir AlpineBuilder
          wsl --import AlpineBuilder ./RockyBuilder ./${WSL_FILE} --version 2

      - name: AlpineBuilder Prapare Environment
        shell: bash
        run: |
          wsl -d AlpineBuilder -- sh -s <<'WSL_EOF'
            cd /root
            rpm_path="RPM_PATH"
            mkdir -p ${rpm_path}
            echo "üîÑ Âà∑Êñ∞ APK ÁºìÂ≠òÂπ∂Êõ¥Êñ∞Á≥ªÁªü..."
            apk update
            apk upgrade -a  # -a Ë°®Á§∫‰∏ãËΩΩÊâÄÊúâÊõ¥Êñ∞ÂåÖ‰ΩÜ‰∏çÂÆâË£Ö

            echo "üìÇ ÂàáÊç¢Âà∞ RPM Â≠òÊîæÁõÆÂΩï: ${rpm_path}"
            cd "${rpm_path}"
            mkdir -p 01-update 02-base 03-extra 04-docker

            echo "‚¨áÔ∏è [1/4] ‰∏ãËΩΩÁ≥ªÁªüÊõ¥Êñ∞ÂåÖÂà∞ 01-update..."
            apk fetch -L --update-cache -o 01-update/
            echo "‚úÖ Á≥ªÁªüÊõ¥Êñ∞ÂåÖÂáÜÂ§áÂÆåÊàê"

            echo "üì¶ [2/4] ÂÆâË£ÖÁ≥ªÁªüÊõ¥Êñ∞..."
            apk upgrade --no-cache
            echo "‚úÖ Á≥ªÁªüÊõ¥Êñ∞ÂÆåÊàê"

            echo "‚¨áÔ∏è ‰∏ãËΩΩÊûÅÁÆÄÂåÖÂà∞ 02-base ÁõÆÂΩï..."
            apk fetch -R -L -o 02-base busybox tar gzip sudo curl bash
            echo "‚úÖ ‰∏ãËΩΩÂÆåÊàêÔºÅ"
          WSL_EOF

      - name: Build Customize Alpine WSL Image
        shell: bash
        run: |
          wsl -d AlpineBuilder -- sh -s <<'WSL_EOF'
            ORIGINAL_WIN_DIR="$(pwd)"
            echo "ÂéüÂßã Windows ÁõÆÂΩïÔºàWSL ËßÜËßíÔºâ: $ORIGINAL_WIN_DIR"
            echo "üì¶ ÂÆâË£Ö‰æùËµñÂ∑•ÂÖ∑..."
            apk add xz gzip tar

            gz_name="$(ls *.gz | head -1)"
            mv "${ORIGINAL_WIN_DIR}/${gz_name}" /root
            mv "${ORIGINAL_WIN_DIR}/Alpine" /root

            cd /root
            echo "  ‚Üí Ëß£Âéã $gz_name ‰∏∫ tar..."
            gzip -d -S .tar -N "$gz_name"
            rm -rf $gz_name

            tar_name="$(ls *.tar | head -1)"
            echo "üìÇ Ëß£ÂåÖ tar ${tar_name}..."
            temp_path="temp_${RANDOM}"
            mkdir -p "${temp_path}"
            tar -pxf "${tar_name}" -C "${temp_path}"
            rm -rf "${tar_name}"
            mv "${temp_path}" "${tar_name}"

            cd "${tar_name}"
            echo "‚öôÔ∏è ‰øÆÊîπÂèëË°åÁâàÈÖçÁΩÆ..."
            mkdir -p tmp/oobe
            mkdir -p etc/sudoers.d
            mkdir -p usr/lib/wsl
            cp -aP ../Alpine/etc/. etc/
            cp -aP ../Alpine/usr/. usr/
            cp -rP ../RPM_PATH/{01-update,02-base,03-extra,06-docker} tmp/oobe/

            echo "üì¶ ÈáçÊñ∞ÊâìÂåÖÈïúÂÉè..."
            tar --numeric-owner --format=posix -cpf "/${tar_name}" -- *
            CURRENT_DATE="$(date +%Y%m%d)"
            NEW_FILENAME="${gz_name%.tar.gz}-${CURRENT_DATE}"
            echo "  ‚Üí XZÊ†ºÂºèÂéãÁº©‰∏≠..."
            xz -9ckvT8 "/${tar_name}" > "../${NEW_FILENAME}.xz.wsl"
            echo -e "\n‚úÖ Â§ÑÁêÜÂÆåÊàê!"
            ls -alh
            cd ../
            ls -alh
            mv *.xz.wsl "${ORIGINAL_WIN_DIR}/"
          WSL_EOF

      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          files: |
            *.xz.wsl
